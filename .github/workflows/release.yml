name: Create Release and ZIP

on:
  push:
    tags:
      - 'v*'  # Trigger en tags v1.0.0, v1.0.1, etc.

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Pillow for logo creation
        run: pip install Pillow

      - name: Create logo.png
        run: |
          cd enviamo_connector
          python create_logo.py
          cd ..

      - name: Create module ZIP with Python
        run: |
          python3 << 'EOF'
          import os
          import zipfile
          from pathlib import Path

          version = "${{ steps.version.outputs.VERSION }}"
          source_dir = Path('enviamo_connector')
          output_zip = Path(f'enviamo-connector-{version}.zip')

          with zipfile.ZipFile(output_zip, 'w', zipfile.ZIP_DEFLATED) as zipf:
              for root, dirs, files in os.walk(source_dir):
                  dirs[:] = [d for d in dirs if not d.startswith('.') and d not in ['tests', 'node_modules', '__pycache__']]
                  for file in files:
                      if file.startswith('.') or file.endswith('.pyc') or file == 'create_logo.py':
                          continue
                      file_path = Path(root) / file
                      arcname = file_path.relative_to(source_dir)
                      arcname_unix = str(arcname).replace('\\', '/')
                      zipf.write(file_path, arcname_unix)

          print(f"ZIP created: {output_zip} ({output_zip.stat().st_size / 1024:.2f} KB)")
          EOF

          # Verificar que el ZIP se cre贸 correctamente
          ls -lh enviamo-connector-${{ steps.version.outputs.VERSION }}.zip

      - name: Generate SHA256 checksum
        id: checksum
        run: |
          CHECKSUM=$(sha256sum enviamo-connector-${{ steps.version.outputs.VERSION }}.zip | awk '{print $1}')
          echo "SHA256=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "SHA256: $CHECKSUM"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: enviamo-connector-${{ steps.version.outputs.VERSION }}.zip
          body: |
            ##  Enviamo Connector v${{ steps.version.outputs.VERSION }}

            ### Descarga
            - **Archivo**: [enviamo-connector-${{ steps.version.outputs.VERSION }}.zip](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/enviamo-connector-${{ steps.version.outputs.VERSION }}.zip)
            - **SHA256**: `${{ steps.checksum.outputs.SHA256 }}`

            ### Instalaci贸n
            1. Descarga el archivo ZIP
            2. Ve a `M贸dulos > Gestor de M贸dulos` en tu admin de PrestaShop
            3. Haz clic en "Subir un m贸dulo"
            4. Arrastra el archivo ZIP descargado
            5. 隆Listo! Ahora conecta tu tienda con Enviamo

            ### Changelog
            Ver [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) para detalles completos.

            ---

            **Compatibilidad**: PrestaShop 1.7.6.0+ | PHP 7.1+ | MySQL 5.6+
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Enviamo Backend
        if: success()
        run: |
          curl -X POST https://backend.parafarmaciaintegrativa.es/api/v1/modules/prestashop/new-release \
            -H "Authorization: Bearer ${{ secrets.ENVIAMO_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"version\": \"${{ steps.version.outputs.VERSION }}\",
              \"download_url\": \"https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/enviamo-connector-${{ steps.version.outputs.VERSION }}.zip\",
              \"sha256\": \"${{ steps.checksum.outputs.SHA256 }}\",
              \"changelog_url\": \"https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md\"
            }" || echo "Failed to notify Enviamo backend (non-critical)"
